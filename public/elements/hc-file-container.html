<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="hc-file-displayer.html"/>
<dom-module id="hc-file-container">

<style>
	#container{
		background-color: #4d4d4d;
	}
	.wrapper{
		position:absolute;
		transition: all 2s;
	}
	
</style>

	<template>
	<div id="container">
	<!-- <hc-file-displayer height width></hc-file-displayer>
	<hc-file-displayer height width></hc-file-displayer> -->
	</div>
	<input type="button" value="rotate-stuff" id="presentation"/>

		
	</template>

	<script src="../js/Sprite3D.js" type="text/javascript"></script>
	<script>
	(function () {
    'use strict';
    Polymer({
      is: 'hc-file-container',
      properties: {
        height:{
          type: Number,
          value:500,
          notify:true
        },
        width:{
          type: Number,
          value:500,
          notify:true
        },
        id:{
          type:String,
          notify:true
        },
        data:{
        	type:Object,
        	value:{
        		name:"placeholder",
        		relations:[
        		{name:"pl1", code:"more code"},
        		{name:"pl2", code:"even more code"} 
        		],
        		source:"some code"
        	}
        },
        files:{
        	type: Object,
        },
        stage:{},

      },
      

      ready:function(){
      	this.width=window.innerWidth-30
      	this.height=window.innerHeight-30
        this.$.container.style.width= this.width+"px" //this.width+"px"
        this.$.container.style.height= this.height+"px"//this.height+"px"
        this.stage = Sprite3D.stage(this.$.container);
        // let mainFile = document.createElement("hc-file-displayer");
        // mainFile.setAttribute("width",400);
        // mainFile.setAttribute("height",300);
        // let x=this.stage.appendChild(Sprite3D.create(mainFile))
        // x.position(500,500).update()
        
        this.setUp();


      },
      setUp:function(){

       let files=[]
       files.push(this.createFileDisplayer(40,90, 50,50,null, true)) //main
       files.push(this.createFileDisplayer(20,60, 15,50))
       files.push(this.createFileDisplayer(20,60, 85,50))
       this.files={list:files, mainIndex:0} // index of main
       let x = this;
       // let elements= Polymer.dom(this.root).querySelectorAll(".wrapper"))
       let app = this;
       for(let i =0; i< files.length; i++){
        files[i].index=i;

        files[i].sprite.onclick=function(e){
          app.swapWithMain(files[i].index)
        }
       }
       this.$.presentation.onclick=function(){
       	// window.setInterval(function(){
       		files.forEach(function(item){
       			item.sprite.rotate(0,180,0).update()
       		})
       	// 	files[1].move(0,4,0)
       	// }, 50)
       }
      },
      //horrible code but only temporary
      swapWithMain:function(index){
      	if(index == this.files.mainIndex){
      		return;
      	}
      	let spriteOne = this.files.list[index]
      	let mainSprite= this.files.list[this.files.mainIndex]
        let posOne = spriteOne.pos
        let posMain = mainSprite.pos
      	spriteOne.sprite.firstChild.setAttribute("width",posMain.width)
        spriteOne.sprite.firstChild.setAttribute("height",posMain.height)
        

        mainSprite.sprite.firstChild.setAttribute("width",posOne.width)
        mainSprite.sprite.firstChild.setAttribute("height",posOne.height)
        // spriteOne.sprite.firstChild.setAttribute("is-editable",true)
        // mainSprite.sprite.firstChild.setAttribute("is-editable",false)

      	spriteOne.sprite.position(posMain.x, posMain.y).update()
      	mainSprite.sprite.position(posOne.x, posOne.y).update()
        for(let key in posOne){
          console.log(key)
          let temp = posOne[key]
          posOne[key] =posMain[key]
          posMain[key] = temp
        }
        this.files.mainIndex = index
        // for(let i=0; i<this.files.list.length;i++){
        //   if(this.files.list[i] !== index){
        //     this.files.list[i].sprite.firstChild.setAttribute("is-editable",false)
        //   }
        // }
        
      	// spriteOne.x
      	// spriteOne.y
      },
      // setWidthHeight:function(width,height){

      // },
      // everythin in percentages according of this.height and this.width
      createFileDisplayer(width, height, x, y,id, active){
      	let percX=this.width/100
      	let percY=this.height/100
      	// let element = document.createElement("hc-file-displayer");
      	let element = document.createElement("div")
      	element.style.width=percX*width+"px";
      	element.style.height=percY*height+"px";
      	console.log(percX*width)
      	element.style.position="absolute"
      	element.className="wrapper"
      	element.style.transition="all 2s"

      	let innerElement = document.createElement("hc-file-displayer");
      	innerElement.setAttribute("width",percX*width);
        innerElement.setAttribute("height",percY*height);
        if(active){
        	// innerElement.setAttribute("is-editable",true);
          innerElement.setAttribute("title","JSONInstances");
          let s ="/*\n *   This program is free software: you can redistribute it and/or modify\n *   it under the terms of the GNU General Public License as published by\n *   the Free Software Foundation, either version 3 of the License, or\n *   (at your option) any later version.\n *\n *   This program is distributed in the hope that it will be useful,\n *   but WITHOUT ANY WARRANTY; without even the implied warranty of\n *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *   GNU General Public License for more details.\n *\n *   You should have received a copy of the GNU General Public License\n *   along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n\n/*\n * JSONInstances.java\n * Copyright (C) 2009-2012 University of Waikato, Hamilton, New Zealand\n */\n\npackage weka.core.json;\n\nimport java.util.ArrayList;\n\nimport weka.core.Attribute;\nimport weka.core.DenseInstance;\nimport weka.core.Instance;\nimport weka.core.Instances;\nimport weka.core.SparseInstance;\nimport weka.core.Utils;\nimport weka.core.converters.ConverterUtils.DataSource;\n\n/**\n * Class for transforming Instances objects into <a href=\"http://www.json.org/\" target=\"_blank\">JSON</a>\n * objects and vice versa. Missing values get stored as \"?\".\n * \n * @author  FracPete (fracpete at waikato dot ac dot nz)\n * @version $Revision$\n * @see #MISSING_VALUE\n */\npublic class JSONInstances {\n\n  /** the header section. */\n  public final static String HEADER = \"header\";\n\n  /** the data section. */\n  public final static String DATA = \"data\";\n\n  /** the relation name. */\n  public final static String RELATION = \"relation\";\n\n  /** the attributes object. */\n  public final static String ATTRIBUTES = \"attributes\";\n\n  /** the name attribute. */\n  public final static String NAME = \"name\";\n\n  /** the type attribute. */\n  public final static String TYPE = \"type\";\n\n  /** the class attribute indicator. */\n  public final static String CLASS = \"class\";\n\n  /** the labels attribute. */\n  public final static String LABELS = \"labels\";\n\n  /** the weight attribute. */\n  public final static String WEIGHT = \"weight\";\n\n  /** the dateformat attribute. */\n  public final static String DATEFORMAT = \"dateformat\";\n\n  /** the sparse attribute. */\n  public final static String SPARSE = \"sparse\";\n\n  /** the values attribute. */\n  public final static String VALUES = \"values\";\n\n  /** the separator for index/value in case of sparse instances. */\n  public final static String SPARSE_SEPARATOR = \":\";\n\n  /** the missing value indicator. */\n  public final static String MISSING_VALUE = \"?\";\n  \n  /**\n   * Turns the JSON object into an Attribute, if possible.\n   * \n   * @param att\t\tthe JSON object to turn into an Attribute\n   * @param classAtt\tfor storing whether the attribute is the class attribute\n   * @return\t\tthe Attribute, null in case of an error\n   */\n  protected static Attribute toAttribute(JSONNode att, boolean[] classAtt) {\n    Attribute\t\tresult;\n    String\t\tname;\n    String\t\ttype;\n    String\t\tdateformat;\n    JSONNode\t\tlabels;\n    ArrayList<String>\tvalues;\n    String\t\tlabel;\n    int\t\t\ti;\n    double\t\tweight;\n    \n    name   = (String) att.getChild(NAME).getValue(\"noname\");\n    type   = (String) att.getChild(TYPE).getValue(\"\");\n    weight = (Double) att.getChild(WEIGHT).getValue(new Double(1.0));\n    if (type.equals(Attribute.typeToString(Attribute.NUMERIC))) {\n      result = new Attribute(name);\n    }\n    else if (type.equals(Attribute.typeToString(Attribute.NOMINAL))) {\n      labels = att.getChild(LABELS);\n      values = new ArrayList<String>();\n      for (i = 0; i < labels.getChildCount(); i++) {\n\tlabel = (String)((JSONNode) labels.getChildAt(i)).getValue();\n\tif (label.equals(\"'\" + MISSING_VALUE + \"'\"))\n\t  values.add(MISSING_VALUE);\n\telse\n\t  values.add(label);\n      }\n      result = new Attribute(name, values);\n    }\n    else if (type.equals(Attribute.typeToString(Attribute.DATE))) {\n      dateformat = (String) att.getChild(DATEFORMAT).getValue(\"yyyy-MM-dd'T'HH:mm:ss\");\n      result     = new Attribute(name, dateformat);\n    }\n    else if (type.equals(Attribute.typeToString(Attribute.STRING))) {\n      result = new Attribute(name, (ArrayList<String>) null);\n    }\n    else {\n      System.err.println(\"Unhandled attribute type '\" + type + \"'!\");\n      return null;\n    }\n    result.setWeight(weight);\n    \n    return result;\n  }\n\n  /**\n   * Turns the JSON Object into an Instance, if possible.\n   * \n   * @param inst\tthe JSON object to turn into an Instance\n   * @param data\tthe data so far (only used for header information)\n   * @return\t\tthe Instance, null in case of an error\n   */\n  protected static Instance toInstance(JSONNode inst, Instances data) {\n    Instance\tresult;\n    boolean\tsparse;\n    double\tweight;\n    JSONNode\tvalues;\n    int\t\ti;\n    int\t\tindex;\n    int\t\tpos;\n    String\tvalue;\n    double[]\tvals;\n\n    sparse = (Boolean) inst.getChild(SPARSE).getValue(new Boolean(false));\n    weight = (Double) inst.getChild(WEIGHT).getValue(new Double(1.0));\n    values = inst.getChild(VALUES);\n    vals   = new double[data.numAttributes()];\n    for (i = 0; i < values.getChildCount(); i++) {\n      if (sparse) {\n\tvalue = \"\" + ((JSONNode) values.getChildAt(i)).getValue();\n\tpos   = value.indexOf(SPARSE_SEPARATOR);\n\tindex = Integer.parseInt(value.substring(0, pos));\n\tvalue = value.substring(pos + 1);\n      }\n      else {\n\tindex = i;\n\tvalue = \"\" + ((JSONNode) values.getChildAt(i)).getValue();\n      }\n      \n      try {\n\tif (value.equals(MISSING_VALUE)) {\n\t  vals[index] = Utils.missingValue();\n\t}\n\telse {\n\t  // unescape '?' labels \n\t  if (value.equals(\"'\" + MISSING_VALUE + \"'\"))\n\t    value = MISSING_VALUE;\n\t  if (data.attribute(index).isNumeric() && !data.attribute(index).isDate()) {\n\t    vals[index] = Double.parseDouble(value);\n\t  }\n\t  else if (data.attribute(index).isNominal()) {\n\t    vals[index] = data.attribute(index).indexOfValue(value);\n\t    if ((vals[index] == -1) && value.startsWith(\"'\") && value.endsWith(\"'\"))\n\t      vals[index] = data.attribute(index).indexOfValue(Utils.unquote(value));\n\t    // FIXME backslashes seem to get escaped twice when creating a JSON file?\n\t    if ((vals[index] == -1) && value.startsWith(\"'\") && value.endsWith(\"'\"))\n\t      vals[index] = data.attribute(index).indexOfValue(Utils.unbackQuoteChars(Utils.unquote(value)));\n\t    if (vals[index] == -1) {\n\t      System.err.println(\"Unknown label '\" + value + \"' for attribute #\" + (index+1) + \"!\");\n\t      return null;\n\t    }\n\t  }\n\t  else if (data.attribute(index).isDate()) {\n\t    vals[index] = data.attribute(index).parseDate(value);\n\t  }\n\t  else if (data.attribute(index).isString()) {\n\t    vals[index] = data.attribute(index).addStringValue(value);\n\t  }\n\t  else {\n\t    System.err.println(\"Unhandled attribute type '\" + Attribute.typeToString(data.attribute(index).type()) + \"'!\");\n\t    return null;\n\t  }\n\t}\n      }\n      catch (Exception e) {\n\tSystem.err.println(\"Error parsing value #\" + (index+1) + \": \" + e.toString());\n\treturn null;\n      }\n    }\n\n    if (sparse)\n      result = new SparseInstance(weight, vals);\n    else\n      result = new DenseInstance(weight, vals);\n    result.setDataset(data);\n      \n    return result;\n  }\n  \n  /**\n   * Turns a JSON object, if possible, into an Instances object.\n   * \n   * @param json\tthe JSON object to convert\n   * @param onlyHeader\twhether to retrieve only the header\n   * @return\t\tthe generated Instances object, null if not possible\n   */\n  protected static Instances toInstances(JSONNode json, boolean onlyHeader) {\n    Instances\tresult;\n    JSONNode\theader;\n    JSONNode\tattributes;\n    JSONNode\tdata;\n    ArrayList<Attribute>\tatts;\n    Attribute\tatt;\n    Instance\tinst;\n    int\t\ti;\n    int\t\tclassIndex;\n    boolean[]\tclassAtt;\n    \n    header = json.getChild(HEADER);\n    if (header == null) {\n      System.err.println(\"No '\" + HEADER + \"' section!\");\n      return null;\n    }\n    data = json.getChild(DATA);\n    if (data == null) {\n      System.err.println(\"No '\" + DATA + \"' section!\");\n      return null;\n    }\n    \n    // attributes\n    attributes = header.getChild(ATTRIBUTES);\n    if (attributes == null) {\n      System.err.println(\"No '\" + ATTRIBUTES + \"' array!\");\n      return null;\n    }\n    atts       = new ArrayList<Attribute>();\n    classAtt   = new boolean[1];\n    classIndex = -1;\n    for (i = 0; i < attributes.getChildCount(); i++) {\n      att = toAttribute((JSONNode) attributes.getChildAt(i), classAtt);\n      if (att == null) {\n\tSystem.err.println(\"Could not convert attribute #\" + (i+1) + \"!\");\n\treturn null;\n      }\n      if (classAtt[0])\n\tclassIndex = i;\n      atts.add(att);\n    }\n    result = new Instances(\n\theader.getChild(RELATION).getValue(\"unknown\").toString(), \n\tatts, \n\t(onlyHeader ? 0 : data.getChildCount()));\n    result.setClassIndex(classIndex);\n    \n    // data\n    if (!onlyHeader) {\n      for (i = 0; i < data.getChildCount(); i++) {\n\tinst = toInstance((JSONNode) data.getChildAt(i), result);\n\tif (inst == null) {\n\t  System.err.println(\"Could not convert instance #\" + (i+1) + \"!\");\n\t  return null;\n\t}\n\tresult.add(inst);\n      }\n    }\n    \n    return result;\n  }\n  \n  /**\n   * Turns a JSON object, if possible, into an Instances object.\n   * \n   * @param json\tthe JSON object to convert\n   * @return\t\tthe generated Instances object, null if not possible\n   */\n  public static Instances toInstances(JSONNode json) {\n    return toInstances(json, false);\n  }\n  \n  /**\n   * Turns a JSON object, if possible, into an Instances object (only header).\n   * \n   * @param json\tthe JSON object to convert\n   * @return\t\tthe generated Instances header object, null if not possible\n   */\n  public static Instances toHeader(JSONNode json) {\n    return toInstances(json, true);\n  }\n  \n  /**\n   * Turns the Attribute into a JSON object.\n   * \n   * @param inst\tthe corresponding dataset\n   * @param att\t\tthe attribute to convert\n   * @return\t\tthe JSON object\n   */\n  protected static JSONNode toJSON(Instances inst, Attribute att) {\n    JSONNode\tresult;\n    JSONNode\tlabels;\n    int\t\ti;\n    \n    result = new JSONNode();\n\n    result.addPrimitive(NAME, att.name());\n    result.addPrimitive(TYPE, Attribute.typeToString(att));\n    result.addPrimitive(CLASS, (att.index() == inst.classIndex()));\n    result.addPrimitive(WEIGHT, att.weight());\n    if (att.isNominal()) {\n      labels = result.addArray(LABELS);\n      for (i = 0; i < att.numValues(); i++) {\n\tif (att.value(i).equals(MISSING_VALUE))\n\t  labels.addArrayElement(\"'\" + att.value(i) + \"'\");\n\telse\n\t  labels.addArrayElement(att.value(i));\n      }\n    }\n    if (att.isDate())\n      result.addPrimitive(DATEFORMAT, att.getDateFormat());\n    \n    return result;\n  }\n  \n  /**\n   * Turns the Instance into a JSON object.\n   * \n   * @param inst\tthe Instance to convert\n   * @return\t\tthe JSON object\n   */\n  protected static JSONNode toJSON(Instance inst) {\n    JSONNode\tresult;\n    JSONNode\tvalues;\n    int\t\ti;\n    boolean\tsparse;\n    \n    result = new JSONNode();\n    \n    sparse = (inst instanceof SparseInstance);\n    result.addPrimitive(SPARSE, sparse);\n    result.addPrimitive(WEIGHT, inst.weight());\n    values = result.addArray(VALUES);\n    if (sparse) {\n      for (i = 0; i < inst.numValues(); i++) {\n\tif (inst.isMissing(inst.index(i)))\n\t  values.addArrayElement(inst.index(i) + SPARSE_SEPARATOR + MISSING_VALUE);\n\telse if (inst.toString(inst.index(i)).equals(\"'\" + MISSING_VALUE + \"'\"))\n\t  values.addArrayElement(inst.index(i) + SPARSE_SEPARATOR + \"'\" + MISSING_VALUE + \"'\");  // escape '?' labels\n\telse\n\t  values.addArrayElement(inst.index(i) + SPARSE_SEPARATOR + inst.toString(inst.index(i)));\n      }\n    }\n    else {\n      for (i = 0; i < inst.numAttributes(); i++) {\n\tif (inst.isMissing(i))\n\t  values.addArrayElement(MISSING_VALUE);\n\telse if (inst.toString(i).equals(\"'\" + MISSING_VALUE + \"'\"))\n\t  values.addArrayElement(\"'\" + MISSING_VALUE + \"'\");  // escape '?' labels\n\telse\n\t  values.addArrayElement(inst.toString(i));\n      }\n    }\n    \n    return result;\n  }\n  \n  /**\n   * Turns the Instances object into a JSON object.\n   * \n   * @param inst\tthe Instances to turn into a JSON object\n   * @return\t\tthe JSON object\n   */\n  public static JSONNode toJSON(Instances inst) {\n    JSONNode\tresult;\n    JSONNode\theader;\n    JSONNode\tatts;\n    JSONNode\tdata;\n    int\t\ti;\n    \n    result = new JSONNode();\n    \n    // header\n    header = result.addObject(HEADER);\n    header.addPrimitive(RELATION, inst.relationName());\n    atts = header.addArray(ATTRIBUTES);\n    for (i = 0; i < inst.numAttributes(); i++)\n      atts.add(toJSON(inst, inst.attribute(i)));\n    \n    // data\n    data = result.addArray(DATA);\n    for (i = 0; i < inst.numInstances(); i++)\n      data.add(toJSON(inst.instance(i)));\n    \n    return result;\n  }\n  \n  /**\n   * For testing only.\n   * \n   * @param args\texpects a dataset as first parameter\n   * @throws Exception\tif something goes wrong\n   */\n  public static void main(String[] args) throws Exception {\n    if (args.length != 1) {\n      System.err.println(\"No dataset supplied!\");\n      System.exit(1);\n    }\n\n    // load dataset\n    Instances data = DataSource.read(args[0]);\n    \n    // turn Instances into JSON object and output it\n    JSONNode json = toJSON(data);\n    StringBuffer buffer = new StringBuffer();\n    json.toString(buffer);\n    System.out.println(buffer.toString());\n    \n    // turn JSON object back into Instances and output it\n    Instances inst = toInstances(json);\n    System.out.println(inst);\n  }\n}\n"
          innerElement.setAttribute("code",s);
        }
        element.appendChild(innerElement)
        let sprite = this.stage.appendChild(Sprite3D.create(element));
        sprite.position(percX*x-innerElement.width/2, percY*y-innerElement.height/2).update();

       
        return{sprite:sprite,
          pos:{
            x:percX*x-innerElement.width/2,
            y:percY*y-innerElement.height/2,
            width:percX*width,
            height:percY*height
          }};
      }

    });
})();

	</script>

</dom-module>